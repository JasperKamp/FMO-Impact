---
title: "Prototype KPI-script: Absolute GHG Accounting"
author: "Gerrit Versteeg"
date: "March 31th, 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Absolute GHG Accounting
This KPI-script calculates

## Four models

## Overview steps in script

# Data Processing
## Setting up the environment

***
IN/OUTPUT

| In/Out | Filename   |  Size | Description |
|:------|:------------------|----:|:------------------------------|
| Input | CustFac_General.csv | 247/18 | |
| Input | IC_Corporate.csv | 48/7 | |
| Input | IC_ProjFin.csv | 59/6 | |
| Input | IC_FinInst.csv | 101/23 | |
| Input | IC_PrivEq.csv | 39/43 | |
| Input | PEF_Investments.csv | 117/5 | |
| Input | PEF_RegionPerc.csv | 18/3 | |
| Input | Fctr_EcEmis1.csv | 23/19 | |
| Input | Fctr_EcEmis2.csv | 23/19 | |
| Input | Fctr_CapInt.csv | 23/19 | |
| Input | Fctr_CBbrkdwn.csv | 23/17 | |
| Input | Fctr_Out2Elec.csv | 23/17 | |
| LUT | MAP_CntrReg.csv | 87/2 | |
| LUT | MAP_SctrMdl.csv | 21/2 | |
| LUT | MAP_ICSctrMdl.csv | 18/2 | |

***

```{r setup_env,ECHO = TRUE}
library("tidyverse", warn.conflicts=FALSE)      ## load tidyverse silently

## Source micro-services
## 1. contains all microservices for first KPI
source("microservices/uS001_PE_InvPct.R")
source("microservices/uS002_PE_ConsolidateFactors.R")
source("microservices/uS003_PE_ConsolidateSectors.R")
source("microservices/uS004_PE_ConsolidateSize.R")
source("microservices/uS005_AbsEms_Corp.R")
source("microservices/uS006_AbsEms_PrFin.R")

## Setup locations
rawdir <- "datalake/raw_data/"
lutdir <- "datalake/luts/"
clndir <- "datalake/clean_data/"
valdir <- "datalake/valid_data/"
inddir <- "datalake/indicators/"
dptdir <- "datalake/data_points/"
laydir <- "datalake/infoproducts/GIS_layers/"
qlkdir <- "datalake/infoproducts/Qlik_cubes/"
sopdir <- "datalake/infoproducts/sopact_sheets/"

## Setup parameters
version <- ""
indate = "2019-03-31"
lutdate = "2019-03-31"
outdate = "2019-03-31"

## Setup filenames
fname_in_custG <- paste0(clndir,"CustFac_General", "_", outdate,".csv")
fname_in_ICCp <- paste0(clndir,"IC_Corporate", "_", outdate,".csv")
fname_in_ICPF <- paste0(clndir,"IC_ProjFin", "_", outdate,".csv")
fname_in_ICFI <- paste0(clndir,"IC_FinInst", "_", outdate,".csv")
fname_in_ICPE <- paste0(clndir,"IC_PrivEq", "_", outdate,".csv")
fname_in_PEFInv <- paste0(clndir,"PEF_Investments", "_", outdate,".csv")
fname_in_PEFReg <- paste0(clndir,"PEF_RegionPerc", "_", outdate,".csv")
fname_in_EcEF1 <- paste0(clndir,"Fctr_EcEmis1", "_", outdate,".csv")
fname_in_EcEF2 <- paste0(clndir,"Fctr_EcEmis2", "_", outdate,".csv")
fname_in_CpIF <- paste0(clndir,"Fctr_CapInt", "_", outdate,".csv")
fname_in_CBBD <- paste0(clndir,"Fctr_CBbrkdwn", "_", outdate,".csv")
fname_in_OutElc <- paste0(clndir,"Fctr_Out2Elec", "_", outdate,".csv")
fname_in_lutC <- paste0(lutdir,"Map_CntrReg", "_", outdate,".csv")
fname_in_lutS <- paste0(lutdir,"Map_SctrMdl", "_", outdate,".csv")
fname_in_lutICS <- paste0(lutdir,"Map_ICSctrMdl", "_", outdate,".csv")
fname_out <- paste0(inddir,"KPI_AbsGHGAcc", "_", outdate,".csv")

```


## General customers
### Determining customer types

```{r 1.PEF-InvPct, ECHO = TRUE}
custG <- read.csv2(fname_in_custG, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
table(custG$IC_type)
```


## Prive Equity Fund Preparation
### Determining Investment Percentages per Country
Calculate investment percentage per PEF-customer per country

```{r 1.PEF-InvPct, ECHO = TRUE}
PEFInv <- read.csv2(fname_in_PEFInv, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
PEFReg <- read.csv2(fname_in_PEFReg, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
PEFInvPct <- uS001_PE_InvPct(investments = PEFInv,
                             contracted = PEFReg)
head(PEFInvPct, 5)
```

### Consolidating PK-Factors (Cap.Intensity)
Consolidate Capital Intensity Factors (GHG-country/sector) per customer

```{r 2.PEF-ConsPKFct, ECHO = TRUE}
CpIF <- read.csv2(fname_in_CpIF, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
PEF_ConsPKfctrs <- uS002_PE_ConsolidateFactors(invperc = PEFInvPct,
                             factors = CpIF)
head(PEF_ConsPKfctrs, 5)
```
### Consolidating EcEF - scope 2
Consolidate emission fators (scope 2) per customer

```{r 3.PEF-ConsEc2Fct, ECHO = TRUE}
EcEF2 <- read.csv2(fname_in_EcEF2, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
PEF_ConsEC2fctrs <- uS002_PE_ConsolidateFactors(invperc = PEFInvPct,
                             factors = EcEF2)
head(PEF_ConsEC2fctrs, 5)
```
### Consolidating EcEF - scope 1
Consolidate emission fators (scope 1) per customer

```{r 4.PEF-ConsEc1Fct, ECHO = TRUE}
EcEF1 <- read.csv2(fname_in_EcEF1, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
PEF_ConsEC1fctrs <- uS002_PE_ConsolidateFactors(invperc = PEFInvPct,
                             factors = EcEF1)
head(PEF_ConsEC1fctrs, 5)
```
### Consolidate IC-Sectors per PEF-customer
Calculate the PEF-investments (or contracted if not present) for each PEF-customer for each Impact Card Sector

```{r 5.PEF-ConsSect, ECHO = TRUE}
ICPE <- read.csv2(fname_in_ICPE, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
PEFInv <- read.csv2(fname_in_PEFInv, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
PEFConsSctrs <- uS003_PE_ConsolidateSectors(investments = PEFInv,
                             contracted = ICPE)
head(PEFConsSctrs, 5)
```

### Consolidate investments towards size per PEF-customer
Calculate the PEF-investments (or contracted if not present) for each PEF-customer for each size (SME versus Corporate)

```{r 6.PEF-ConsSect, ECHO = TRUE}
ICPE <- read.csv2(fname_in_ICPE, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
PEFInv <- read.csv2(fname_in_PEFInv, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
PEFConsSize <- uS004_PE_ConsolidateSize(investments = PEFInv,
                             contracted = ICPE)
head(PEFConsSize, 5)
```


## Calculate Absolute Emissions

### Corporates (scope 1)

Calculate absolute emissions (Scope 1) for each Corporate customer.

```{r 7.AbsEms-Corp1, ECHO = TRUE}
custG <- read.csv2(fname_in_custG, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
custG <- custG[custG$IC_type == "corporate",]
ICCp <- read.csv2(fname_in_ICCp, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
EcEF <- read.csv2(fname_in_EcEF1, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
lutC <- read.csv2(fname_in_lutC, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
lutS <- read.csv2(fname_in_lutS, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")

AE_Corp1 <- uS005_AbsEms_Corp(impactcard = ICCp,
                             customers = custG,
                             factors = EcEF,
                             scope = 1,
                             countrymap = lutC,
                             sectormap = lutS)
head(AE_Corp1, 5)
```

### Corporates (scope 2)

Calculate absolute emissions (Scope 2) for each Corporate customer.

```{r 8.AbsEms-Corp2, ECHO = TRUE}
custG <- read.csv2(fname_in_custG, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
custG <- custG[custG$IC_type == "corporate",]
ICCp <- read.csv2(fname_in_ICCp, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
EcEF <- read.csv2(fname_in_EcEF2, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
lutC <- read.csv2(fname_in_lutC, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
lutS <- read.csv2(fname_in_lutS, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")

AE_Corp2 <- uS005_AbsEms_Corp(impactcard = ICCp,
                             customers = custG,
                             factors = EcEF,
                             scope = 2,
                             countrymap = lutC,
                             sectormap = lutS)
head(AE_Corp2, 5)
```

### Project-Finances (scope 1)

Calculate absolute emissions (Scope 1) for each project finance customer.

```{r 9.AbsEms-PF1, ECHO = TRUE}
custG <- read.csv2(fname_in_custG, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
custG <- custG[custG$IC_type == "project finance",]
ICPF <- read.csv2(fname_in_ICPF, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
EcEF <- read.csv2(fname_in_EcEF1, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
lutC <- read.csv2(fname_in_lutC, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
lutS <- read.csv2(fname_in_lutS, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")

AE_PrFin1 <- uS006_AbsEms_PrFin(impactcard = ICPF,
                             customers = custG,
                             factors = EcEF,
                             scope = 1,
                             countrymap = lutC,
                             sectormap = lutS)
head(AE_PrFin1, 5)
```

### Project-Finances (scope 2)

Calculate absolute emissions (Scope 2) for each project finance customer.

```{r 10.AbsEms-PF2, ECHO = TRUE}
custG <- read.csv2(fname_in_custG, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
ICPF <- read.csv2(fname_in_ICPF, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
custG <- custG[custG$IC_type == "project finance",]
EcEF <- read.csv2(fname_in_EcEF2, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
lutC <- read.csv2(fname_in_lutC, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
lutS <- read.csv2(fname_in_lutS, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")

AE_PrFin2 <- uS006_AbsEms_PrFin(impactcard = ICPF,
                             customers = custG,
                             factors = EcEF,
                             scope = 2,
                             countrymap = lutC,
                             sectormap = lutS)
head(AE_PrFin2, 5)
```
