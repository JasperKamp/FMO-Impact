---
title: "Prototype KPI-script: Absolute GHG Accounting"
author: "Gerrit Versteeg"
date: "March 31th, 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Absolute GHG Accounting
## In short
This script calculates the absolute greenhouse gas emission for all customers of FMO. The GHG-accounting model is based on the FMO Impact Model methodology as described in general in: "FMO Impact Model - methodology document 25 March 2019.pdf".

The calculations used are described in more detail in FMO's technical paper, version 2, October 2018 ("Absolute GHG Accounting Approach.pdf"")

## Four models
Four calculation models are used, sequenced below in prefered usage:

* model 1. use verified, actual GHG emissions (ISO 14064)
* model 2. use primary physical activity data to estimate GHG emission
* model 3. use primary economic activity data to estimate GHG emission
* model 2. use portfolio data to estimate GHG emission

## Overview steps in script


# Data Processing
## Setting up the environment

***
IN/OUTPUT

| In/Out | Filename   |  Size | Description |
|:------|:------------------|----:|:------------------------------|
| Input | CustFac_General.csv | 247/18 | |
| Input | IC_Corporate.csv | 48/7 | |
| Input | IC_ProjFin.csv | 59/6 | |
| Input | IC_FinInst.csv | 101/23 | |
| Input | IC_PrivEq.csv | 39/43 | |
| Input | PEF_Investments.csv | 117/5 | |
| Input | PEF_RegionPerc.csv | 18/3 | |
| Input | Fctr_EcEmis1.csv | 23/19 | |
| Input | Fctr_EcEmis2.csv | 23/19 | |
| Input | Fctr_CapInt.csv | 23/19 | |
| Input | Fctr_CBbrkdwn.csv | 23/17 | |
| Input | Fctr_Out2Elec.csv | 23/17 | |
| LUT | MAP_CntrReg.csv | 87/2 | |
| LUT | MAP_SctrMdl.csv | 21/2 | |
| LUT | MAP_ICSctrMdl.csv | 18/2 | |

***

```{r setup_env, echo=FALSE, warning=FALSE}
library("tidyverse", warn.conflicts=FALSE)      ## load tidyverse silently

## Source micro-services
## 1. contains all microservices for first KPI
source("microservices/uS005_AbsEms_Corp.R")
source("microservices/uS006_AbsEms_PrFin.R")
source("microservices/uS007_AbsEms_PrEq.R")

## Setup locations
rawdir <- "datalake/raw_data/"
lutdir <- "datalake/luts/"
clndir <- "datalake/clean_data/"
valdir <- "datalake/valid_data/"
inddir <- "datalake/indicators/"
dptdir <- "datalake/data_points/"
laydir <- "datalake/infoproducts/GIS_layers/"
qlkdir <- "datalake/infoproducts/Qlik_cubes/"
sopdir <- "datalake/infoproducts/sopact_sheets/"

## Setup parameters
version <- ""
indate = "2019-03-31"
lutdate = "2019-03-31"
outdate = "2019-03-31"

## Setup filenames
fname_in_custG <- paste0(clndir,"CustFac_General", "_", outdate,".csv")
fname_in_ICCp <- paste0(clndir,"IC_Corporate", "_", outdate,".csv")
fname_in_ICPF <- paste0(clndir,"IC_ProjFin", "_", outdate,".csv")
fname_in_ICFI <- paste0(clndir,"IC_FinInst", "_", outdate,".csv")
fname_in_ICPE <- paste0(clndir,"IC_PrivEq", "_", outdate,".csv")
fname_in_EcEF1 <- paste0(clndir,"Fctr_EcEmis1", "_", outdate,".csv")
fname_in_EcEF2 <- paste0(clndir,"Fctr_EcEmis2", "_", outdate,".csv")
fname_in_CpIF <- paste0(clndir,"Fctr_CapInt", "_", outdate,".csv")
fname_in_CBBD <- paste0(clndir,"Fctr_CBbrkdwn", "_", outdate,".csv")

fname_in_lutC <- paste0(lutdir,"Map_CntrReg", "_", outdate,".csv")
fname_in_lutS <- paste0(lutdir,"Map_SctrMdl", "_", outdate,".csv")
fname_in_lutICS <- paste0(lutdir,"Map_ICSctrMdl", "_", outdate,".csv")

fname_in_PEFConsPKfctrs <- paste0(dptdir,"PEF_ConsPKF", "_", outdate,".csv")
fname_in_PEFConsEC1fctrs <- paste0(dptdir,"PEF_ConsECF1", "_", outdate,".csv")
fname_in_PEFConsEC2fctrs <- paste0(dptdir,"PEF_ConsECF2", "_", outdate,".csv")
fname_in_PEFConsSize <- paste0(dptdir,"PEF_ConsSize", "_", outdate,".csv")
fname_in_PEFConsSctrs <- paste0(dptdir,"PEF_ConsSctrs", "_", outdate,".csv")

fname_out_AE_Corp1 <- paste0(inddir,"KPI_aGHG_Corp1", "_", outdate,".csv")
fname_out_AE_Corp2 <- paste0(inddir,"KPI_aGHG_Corp2", "_", outdate,".csv")
fname_out_AE_PrFin1 <- paste0(inddir,"KPI_aGHG_PrFin1", "_", outdate,".csv")
fname_out_AE_PrFin2 <- paste0(inddir,"KPI_aGHG_PrFin2", "_", outdate,".csv")
fname_out_AE_PrEq1 <- paste0(inddir,"KPI_aGHG_PrEq1", "_", outdate,".csv")
fname_out_AE_PrEq2 <- paste0(inddir,"KPI_aGHG_PrEq2", "_", outdate,".csv")
fname_out_AE_FI1 <- paste0(inddir,"KPI_aGHG_FI1", "_", outdate,".csv")
fname_out_AE_FI2 <- paste0(inddir,"KPI_aGHG_FI2", "_", outdate,".csv")

```


## General customers
### Determining customer types

```{r 1.PEF-InvPct, ECHO = TRUE}
custG <- read.csv2(fname_in_custG, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
table(custG$IC_type)
```

## Calculate Absolute Emissions

### Corporates (scope 1)

Calculate absolute emissions (Scope 1) for each Corporate customer.

```{r 7.AbsEms-Corp1, ECHO = TRUE}
custG <- read.csv2(fname_in_custG, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
custG <- custG[custG$IC_type == "corporate",]
ICCp <- read.csv2(fname_in_ICCp, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
EcEF <- read.csv2(fname_in_EcEF1, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
lutC <- read.csv2(fname_in_lutC, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
lutS <- read.csv2(fname_in_lutS, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")

AE_Corp1 <- uS005_AbsEms_Corp(impactcard = ICCp,
                             customers = custG,
                             factors = EcEF,
                             scope = 1,
                             countrymap = lutC,
                             sectormap = lutS)
write.csv2(AE_Corp1, file = fname_out_AE_Corp1, row.names = FALSE,
           fileEncoding = "UTF-8")

head(AE_Corp1, 10)
```

### Corporates (scope 2)

Calculate absolute emissions (Scope 2) for each Corporate customer.

```{r 8.AbsEms-Corp2, ECHO = TRUE}
EcEF <- read.csv2(fname_in_EcEF2, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")

AE_Corp2 <- uS005_AbsEms_Corp(impactcard = ICCp,
                             customers = custG,
                             factors = EcEF,
                             scope = 2,
                             countrymap = lutC,
                             sectormap = lutS)
write.csv2(AE_Corp2, file = fname_out_AE_Corp2, row.names = FALSE,
           fileEncoding = "UTF-8")

table(AE_Corp2$method)
```

### Project-Finances (scope 1)

Calculate absolute emissions (Scope 1) for each project finance customer.

```{r 9.AbsEms-PF1, ECHO = TRUE}
custG <- read.csv2(fname_in_custG, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
custG <- custG[custG$IC_type == "project finance",]
ICPF <- read.csv2(fname_in_ICPF, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")
EcEF <- read.csv2(fname_in_EcEF1, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")

AE_PrFin1 <- uS006_AbsEms_PrFin(impactcard = ICPF,
                             customers = custG,
                             factors = EcEF,
                             scope = 1,
                             countrymap = lutC,
                             sectormap = lutS)

write.csv2(AE_PrFin1, file = fname_out_AE_PrFin1, row.names = FALSE,
           fileEncoding = "UTF-8")

hist(AE_PrFin1$abs_ems, main = "Histogram of Emissions",
     xlab = "Absolute emissions")
```

### Project-Finances (scope 2)

Calculate absolute emissions (Scope 2) for each project finance customer.

```{r 10.AbsEms-PF2, ECHO = TRUE}
EcEF <- read.csv2(fname_in_EcEF2, stringsAsFactors = FALSE,
                    fileEncoding = "UTF-8")

AE_PrFin2 <- uS006_AbsEms_PrFin(impactcard = ICPF,
                             customers = custG,
                             factors = EcEF,
                             scope = 2,
                             countrymap = lutC,
                             sectormap = lutS)

write.csv2(AE_PrFin2, file = fname_out_AE_PrFin2, row.names = FALSE,
           fileEncoding = "UTF-8")

sum(AE_PrFin2$abs_ems, na.rm = TRUE)
```
### Private Equity Funds (scope 1)

Calculate absolute emissions (scope 1) for each Private Equity Fund customer.

```{r 11.AbsEms-PE1, echo=FALSE}
# custG <- read.csv2(fname_in_custG, stringsAsFactors = FALSE,
#                     fileEncoding = "UTF-8")
# custG <- custG[custG$IC_type == "Private Equity Fund",]
# lutICS <- read.csv2(fname_in_lutICS, stringsAsFactors = FALSE,
#                     fileEncoding = "UTF-8")
# PEF_ConsEC1fctrs <- read.csv2(fname_in_PEFConsEC1fctrs, 
#                             stringsAsFactors = FALSE, fileEncoding = "UTF-8")
# PEF_ConsPKfctrs <- read.csv2(fname_in_PEFConsPKfctrs, 
#                             stringsAsFactors = FALSE, fileEncoding = "UTF-8")
# PEF_ConsSize <- read.csv2(fname_in_PEFConsSize, 
#                             stringsAsFactors = FALSE, fileEncoding = "UTF-8")
# PEF_ConsSctrs <- read.csv2(fname_in_PEFConsSctrs, 
#                             stringsAsFactors = FALSE, fileEncoding = "UTF-8")
# 
# AE_PrEq1 <- uS007_AbsEms_PrEq(customers = custG,
#                              ecfactors = PEF_ConsEC1fctrs,
#                              pkfactors = PEF_ConsPKfctrs,
#                              sizes = PEF_ConsSize,
#                              sectors = PEF_ConsSctrs,
#                              costPK_msme = 1.2,
#                              costPK_corp = 0.73,
#                              sectormap = lutICS)
# head(AE_PrEq1, 5)
```
